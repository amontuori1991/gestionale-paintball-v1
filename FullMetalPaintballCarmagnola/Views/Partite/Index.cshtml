@using Full_Metal_Paintball_Carmagnola.Models

@{
    ViewData["Title"] = "Gestione Partite";
    var partiteFuture = ViewBag.PartiteFuture as List<Partita>;
    var partitePassate = ViewBag.PartitePassate as List<Partita>;
    var partiteCancellate = ViewBag.PartiteCancellate as List<Partita>;
}

<!-- SweetAlert2 CSS e JS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
<link href="~/css/partite-responsive.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .overlay-spinner {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        border: 6px solid rgba(255,255,255,0.25);
        border-top-color: rgba(255,255,255,0.95);
        animation: overlaySpin 0.9s linear infinite;
    }

    @@keyframes overlaySpin {
        to

    {
        transform: rotate(360deg);
    }

    }
</style>

<div class="ios26-page">

    <!-- Header / Large Title + Toolbar -->
    <div class="card-v p-3 p-lg-4 mb-3">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <h1 class="large-title m-0">Gestione Partite</h1>

            <div class="toolbar-ios d-flex flex-wrap gap-2">
                <a class="btn btn-ios btn-ios-success" href="@Url.Action("Create", "Partite")">
                    <i class="bi bi-plus-circle me-1"></i> Aggiungi Partita
                </a>
                <a class="btn btn-ios btn-ios-secondary" href="@Url.Action("Archivio", "Partite")">
                    <i class="bi bi-folder2-open me-1"></i> Archivio
                </a>
                <a class="btn btn-ios btn-ios-primary" href="@Url.Action("Semplificata", "Partite")">
                    <i class="bi bi-stars me-1"></i> Visualizzazione Semplificata
                </a>
            </div>
        </div>
    </div>

    <!-- Sezioni Tabelle -->
    <div class="card-v p-3 p-lg-4 mb-3">
        @Html.Partial("_PartiteTable", partiteFuture, new ViewDataDictionary(ViewData) { { "Titolo", "📅 Prossime Partite" } })
    </div>

    <div class="card-v p-3 p-lg-4 mb-3">
        @Html.Partial("_PartiteTable", partitePassate, new ViewDataDictionary(ViewData) { { "Titolo", "✅ Partite Disputate" } })
    </div>

    <div class="card-v p-3 p-lg-4">
        @Html.Partial("_PartiteTable", partiteCancellate, new ViewDataDictionary(ViewData) { { "Titolo", "❌ Partite Annullate" } })
    </div>
</div>

<!-- Modal Riferimento -->
<div class="modal fade" id="riferimentoModal" tabindex="-1" aria-labelledby="riferimentoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Riferimento Prenotazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                <span id="riferimentoContent"></span>
            </div>
        </div>
    </div>
</div>

<!-- Overlay di attesa per invio recensione -->
<div id="overlay-recensione" style="
    display:none;
    position:fixed;
    inset:0;
    background-color:rgba(0,0,0,0.7);
    z-index:9999;
    align-items:center;
    justify-content:center;
    text-align:center;
">
    <div style="display:flex; flex-direction:column; align-items:center; gap:14px; padding:20px;">
        <div class="overlay-spinner" aria-hidden="true"></div>
        <div style="font-size:1.25rem; color:white; font-weight:700;">
            Invio recensione in corso, attendere...
        </div>
    </div>
</div>


@section Scripts {
    <script>
        function showRiferimento(rif) {
            const modal = new bootstrap.Modal(document.getElementById('riferimentoModal'));
            document.getElementById('riferimentoContent').textContent = rif ?? "";
            modal.show();
        }

        $(document).ready(function () {

            $('.staff-select').on('change', function () {
                var select = $(this);
                var campo = select.data('campo');
                var partitaId = select.data('partita');
                var valore = select.val();

                $.ajax({
                    url: '@Url.Action("AggiornaStaff", "Partite")',
                    method: 'POST',
                    data: { id: partitaId, campo: campo, valore: valore },
                    success: function (response) {
                        if (!response.success) {
                            alert(response.message || "Errore durante l'aggiornamento dello staff");
                            console.error("Errore dal server:", response);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Errore durante l\'aggiornamento dello staff');
                        console.error("Dettaglio errore:", error, xhr.responseText);
                    }
                });
            });

        $('.btn-invia-recensione').on('click', function () {
            const btn = $(this);
            var partitaId = btn.data('id');

                Swal.fire({
                    title: 'Sei sicuro?',
                    text: "Vuoi inviare la richiesta di recensione per la partita selezionata?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Invia',
                    cancelButtonText: 'Annulla'
                }).then((result) => {
                    if (result.isConfirmed) {
                        btn.prop('disabled', true);
                        $('#overlay-recensione').css('display', 'flex');
                        $.ajax({
                            url: '@Url.Action("InviaRecensione", "Partite")',
                            method: 'POST',
                            data: { id: partitaId },
                            success: function (response) {
                                $('#overlay-recensione').hide();
                                btn.prop('disabled', false);
                                if (response.success) {
                                    Swal.fire('Inviato!', response.message || 'Email inviate con successo!', 'success');
                                } else {
                                    Swal.fire('Errore', response.message || 'Errore nell\'invio delle email.', 'error');
                                }
                            },
        error: function () {
            $('#overlay-recensione').hide();
            btn.prop('disabled', false);
            Swal.fire('Errore', 'Errore nell\'invio delle email.', 'error');
        }

                        });
                    }
                });
            });

            $('.btn-messaggio-prenotazione').on('click', function () {
                var partitaId = $(this).data('id');

                $.ajax({
                    url: '@Url.Action("GeneraMessaggioPrenotazione", "Partite")',
                    method: 'GET',
                    data: { id: partitaId },
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                title: 'Messaggio Prenotazione',
                                html: `<div id="messaggioTestoSelezionabile" style="width:100%;max-height:400px;overflow-y:auto;border:1px solid #ccc;padding:10px;text-align:left;user-select:text;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;white-space:pre-wrap;word-break:break-word;">${response.messaggio}</div>`,
                                icon: 'info',
                                confirmButtonText: 'Chiudi',
                                showConfirmButton: true,
                                showDenyButton: true,
                                denyButtonText: 'Copia Testo',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    document.getElementById('messaggioTestoSelezionabile').focus();
                                },
                                preDeny: () => {
                                    const textElement = document.getElementById('messaggioTestoSelezionabile');
                                    if (textElement) {
                                        const range = document.createRange();
                                        range.selectNodeContents(textElement);
                                        const selection = window.getSelection();
                                        selection.removeAllRanges();
                                        selection.addRange(range);

                                        try {
                                            const ok = document.execCommand('copy');
                                            if (ok) {
                                                Swal.fire('Copiato!', 'Il testo è stato copiato negli appunti.', 'success');
                                            } else {
                                                navigator.clipboard.writeText(textElement.innerText)
                                                    .then(() => Swal.fire('Copiato!', 'Il testo è stato copiato negli appunti.', 'success'))
                                                    .catch(err => {
                                                        Swal.fire('Errore', 'Impossibile copiare automaticamente. Seleziona manualmente.', 'error');
                                                        console.error('Clipboard API:', err);
                                                    });
                                            }
                                        } catch (err) {
                                            navigator.clipboard.writeText(textElement.innerText)
                                                .then(() => Swal.fire('Copiato!', 'Il testo è stato copiato negli appunti.', 'success'))
                                                .catch(err => {
                                                    Swal.fire('Errore', 'Impossibile copiare automaticamente. Seleziona manualmente.', 'error');
                                                    console.error('Clipboard API:', err);
                                                });
                                        }
                                    }
                                    return false;
                                }
                            });
                        } else {
                            Swal.fire('Errore', response.messaggio || 'Impossibile generare il messaggio.', 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Errore', 'Errore durante la generazione del messaggio.', 'error');
                    }
                });
            });

        });

        $(document).on('click', '.btn-verifica-presenze', function () {
            var data = $(this).data('data');
            $.get('/Partite/PresenzeStaffPopup', { data: data })
                .done(function (response) {
                    Swal.fire({
                        title: 'Presenze Staff',
                        html: response,
                        width: '600px',
                        showConfirmButton: false
                    });
                })
                .fail(function () {
                    Swal.fire('Errore', 'Impossibile recuperare le presenze.', 'error');
                });
        });
    </script>
}
