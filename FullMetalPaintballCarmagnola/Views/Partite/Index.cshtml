@using Full_Metal_Paintball_Carmagnola.Models

@{
    ViewData["Title"] = "Gestione Partite";
    var partiteFuture = ViewBag.PartiteFuture as List<Partita>;
    var partitePassate = ViewBag.PartitePassate as List<Partita>;
    var partiteCancellate = ViewBag.PartiteCancellate as List<Partita>;
    var staffList = new List<string> { "Simone", "Enrico", "Federico", "Davide", "Andrea" };
}

<!-- SweetAlert2 CSS e JS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container-list">
    <div class="list-container">

        <h2>Gestione Partite</h2>

        <p>
            <a class="btn btn-success" href="@Url.Action("Create", "Partite")">➕ Aggiungi Partita</a>
        </p>


        @Html.Partial("_PartiteTable", partiteFuture, new ViewDataDictionary(ViewData) { { "Titolo", "📅 Prossime Partite" } })


        @Html.Partial("_PartiteTable", partitePassate, new ViewDataDictionary(ViewData) { { "Titolo", "✅ Partite Disputate" } })


        @Html.Partial("_PartiteTable", partiteCancellate, new ViewDataDictionary(ViewData) { { "Titolo", "❌ Partite Annullate" } })


    </div>
</div>

<!-- Modal Riferimento -->
<div class="modal fade" id="riferimentoModal" tabindex="-1" aria-labelledby="riferimentoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Riferimento Prenotazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                <span id="riferimentoContent"></span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showRiferimento(rif) {
            const modal = new bootstrap.Modal(document.getElementById('riferimentoModal'));
            document.getElementById('riferimentoContent').textContent = rif ?? "";
            modal.show();
        }

        $(document).ready(function () {

            $('.staff-select').on('change', function () {
                var select = $(this);
                var campo = select.data('campo');
                var partitaId = select.data('partita');
                var valore = select.val();

                $.ajax({
                    url: '@Url.Action("AggiornaStaff", "Partite")',
                    method: 'POST',
                    data: { id: partitaId, campo: campo, valore: valore },
                    success: function () {
                        console.log('Aggiornamento Staff riuscito');
                    },
                    error: function () {
                        alert('Errore durante l\'aggiornamento dello staff');
                    }
                });
            });

            $('.btn-invia-recensione').on('click', function () {
                var partitaId = $(this).data('id');
                Swal.fire({
                    title: 'Sei sicuro?',
                    text: "Vuoi inviare la richiesta di recensione per la partita selezionata?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Invia',
                    cancelButtonText: 'Annulla'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("InviaRecensione", "Partite")',
                            method: 'POST',
                            data: { id: partitaId },
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire('Inviato!', response.message || 'Email inviate con successo!', 'success')
                                } else {
                                    Swal.fire('Errore', response.message || 'Errore nell\'invio delle email.', 'error')
                                }
                            },
                            error: function () {
                                Swal.fire('Errore', 'Errore nell\'invio delle email.', 'error')
                            }
                        });
                    }
                });
            });

                    $('.btn-messaggio-prenotazione').on('click', function () {
            var partitaId = $(this).data('id');

            $.ajax({
                url: '@Url.Action("GeneraMessaggioPrenotazione", "Partite")',
                method: 'GET',
                data: { id: partitaId },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Messaggio Prenotazione',
                            html: `<textarea style="width:100%; height:200px;" readonly>${response.messaggio.replace(/<br>/g, '\n')}</textarea>`,
                            icon: 'info',
                            confirmButtonText: 'Chiudi'
                        });
                    } else {
                        Swal.fire('Errore', response.messaggio || 'Impossibile generare il messaggio.', 'error');
                    }
                },
                error: function () {
                    Swal.fire('Errore', 'Errore durante la generazione del messaggio.', 'error');
                }
            });
        });

        });
    </script>
}
