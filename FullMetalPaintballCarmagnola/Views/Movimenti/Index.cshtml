@model List<Full_Metal_Paintball_Carmagnola.Models.MovimentiViewModel>
@using System.Text.Encodings.Web

@{
    ViewData["Title"] = "Movimenti";
}

<h2 class="text-center">Gestione Movimenti</h2>

@Html.AntiForgeryToken()

<div class="mb-3">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#aggiungiMovimentoModal">
        Aggiungi Movimento Manuale
    </button>
</div>

<div class="table-responsive" style="overflow-x: auto;">
    <table id="tabellaMovimenti" class="table table-bordered align-middle">
        <thead>
            <tr>
                <th>Data</th>
                <th>Ora</th>
                <th>Stato</th>
                <th>Caparra</th>
                <th>Metodo Caparra</th>
                <th>Dare (€)</th>
                <th>Avere (€)</th>
                <th>Dare Bis (€)</th>
                <th>Avere Bis (€)</th>
                <th>Note</th>
                <th>Azioni</th>
            </tr>
            <tr>
                @for (int i = 0; i < 10; i++)
                {
                    <th>
                        <div class="input-group input-group-sm">
                            <input type="text" placeholder="Filtra" class="form-control column-filter-input" data-column-index="@i" />
                            <button class="btn btn-primary apply-filter-btn" type="button" data-column-index="@i">Applica</button>
                        </div>
                    </th>
                }
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Data.ToString("dd/MM/yyyy")</td>
                    <td>@item.Ora.ToString(@"hh\:mm")</td>
                    <td>@item.Stato</td>
                    <td>@item.Caparra.ToString("0.00")</td>
                    <td>@item.MetodoCaparra</td>
                    <td>@item.Dare?.ToString("0.00")</td>
                    <td>@item.Avere?.ToString("0.00")</td>
                    <td>@item.DareBis?.ToString("0.00")</td>
                    <td>@item.AvereBis?.ToString("0.00")</td>
                    <td>@item.Note</td>
                    <td>
                        @if (item.Stato == "Movimento Manuale" && item.ExtraId.HasValue)
                        {
                            <button class="btn btn-sm btn-danger" onclick="confermaElimina(@item.ExtraId.Value)">Elimina</button>
                        }
                        <button class="btn btn-sm btn-primary"
                                onclick="modificaMovimento(
                                                @item.PartitaId,
                                                @(item.ExtraId ?? 0),
                                                @(item.Dare.HasValue? item.Dare.Value.ToString(System.Globalization.CultureInfo.InvariantCulture) : "null"),
                                                @(item.Avere.HasValue? item.Avere.Value.ToString(System.Globalization.CultureInfo.InvariantCulture) : "null"),
                                                @(item.DareBis.HasValue? item.DareBis.Value.ToString(System.Globalization.CultureInfo.InvariantCulture) : "null"),
                                                @(item.AvereBis.HasValue? item.AvereBis.Value.ToString(System.Globalization.CultureInfo.InvariantCulture) : "null"),
                                                '@Html.Raw(JavaScriptEncoder.Default.Encode(item.Note ?? string.Empty))',
                                                '@Html.Raw(JavaScriptEncoder.Default.Encode(item.MetodoCaparra ?? string.Empty))'
                                            )">
                            Modifica
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- MODALE MODIFICA MOVIMENTO -->
<div class="modal fade" id="modificaMovimentoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica Movimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formModificaMovimento">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="modalPartitaId" name="PartitaId" />
                    <input type="hidden" id="modalExtraId" name="ExtraId" />

                    <div class="mb-3">
                        <label for="modalDare" class="form-label">Dare (€)</label>
                        <input type="number" step="0.01" class="form-control" id="modalDare" />
                    </div>
                    <div class="mb-3">
                        <label for="modalAvere" class="form-label">Avere (€)</label>
                        <input type="number" step="0.01" class="form-control" id="modalAvere" />
                    </div>
                    <div class="mb-3">
                        <label for="modalMetodoCaparra" class="form-label">Metodo Caparra</label>
                        <input type="text" class="form-control" id="modalMetodoCaparra" />
                    </div>
                    <div class="mb-3">
                        <label for="modalDareBis" class="form-label">Dare Bis (€)</label>
                        <input type="number" step="0.01" class="form-control" id="modalDareBis" />
                    </div>
                    <div class="mb-3">
                        <label for="modalAvereBis" class="form-label">Avere Bis (€)</label>
                        <input type="number" step="0.01" class="form-control" id="modalAvereBis" />
                    </div>
                    <div class="mb-3">
                        <label for="modalNote" class="form-label">Note</label>
                        <textarea class="form-control" id="modalNote"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button class="btn btn-primary" id="salvaModificheBtn">Salva Modifiche</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var table = $('#tabellaMovimenti').DataTable({
                orderCellsTop: true,
                fixedHeader: true,
                paging: true,
                searching: true,
                info: true,
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/it-IT.json"
                }
            });

            $('#tabellaMovimenti').on('click', '.apply-filter-btn', function () {
                var idx = $(this).data('columnIndex');
                table.column(idx).search($(this).siblings('.column-filter-input').val()).draw();
            });

            $('#tabellaMovimenti').on('keypress', '.column-filter-input', function (e) {
                if (e.which == 13) {
                    var idx = $(this).data('columnIndex');
                    table.column(idx).search($(this).val()).draw();
                }
            });

            $('#salvaModificheBtn').on('click', function () {
                const movimento = {
                    PartitaId: $('#modalPartitaId').val(),
                    ExtraId: $('#modalExtraId').val(),
                    Dare: $('#modalDare').val() || null,
                    Avere: $('#modalAvere').val() || null,
                    DareBis: $('#modalDareBis').val() || null,
                    AvereBis: $('#modalAvereBis').val() || null,
                    Note: $('#modalNote').val(),
                    MetodoCaparra: $('#modalMetodoCaparra').val()
                };

                if (movimento.PartitaId > 0) {
                    fetch('/Movimenti/Salva', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        body: JSON.stringify(movimento)
                    })
                    .then(r => r.ok ? location.reload() : alert('Errore nel salvataggio.'))
                    .catch(() => alert('Errore di rete.'));
                }
                else {
                    alert("Modifica consentita solo per le partite effettive.");
                }
            });
        });

        function modificaMovimento(partitaId, extraId, dare, avere, dareBis, avereBis, note, metodoCaparra) {
            $('#modalPartitaId').val(partitaId);
            $('#modalExtraId').val(extraId);
            $('#modalDare').val(dare !== 'null' ? dare : '');
            $('#modalAvere').val(avere !== 'null' ? avere : '');
            $('#modalDareBis').val(dareBis !== 'null' ? dareBis : '');
            $('#modalAvereBis').val(avereBis !== 'null' ? avereBis : '');
            $('#modalNote').val(note);
            $('#modalMetodoCaparra').val(metodoCaparra);

            var modificaModal = new bootstrap.Modal(document.getElementById('modificaMovimentoModal'));
            modificaModal.show();
        }

        function confermaElimina(extraId) {
            if (confirm("⚠️ Sei sicuro di voler eliminare questo movimento manuale?")) {
                fetch('/Movimenti/EliminaExtra/' + extraId, {
                    method: 'DELETE',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                })
                .then(r => r.ok ? location.reload() : alert('Errore durante l\'eliminazione.'))
                .catch(() => alert('Errore durante l\'eliminazione.'));
            }
        }
    </script>
}
