@using Full_Metal_Paintball_Carmagnola.Models
@model List<AssenzaCalendario>
@using System.Globalization

@{
    ViewData["Title"] = "Calendario Assenze";
}

<style>
    body {
        background-color: #CED4B5;
        font-family: Arial, sans-serif;
    }

    .container-custom {
        padding-top: 120px;
        padding-bottom: 50px;
        max-width: 95%;
        margin: auto;
        position: relative;
    }

    .logo {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        height: 100px;
    }

    .table-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 20px;
    }

    table {
        background-color: white;
        border-collapse: collapse;
        width: 100%;
        min-width: 500px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        background-image: url('/img/splatter1.png'), url('/img/splatter2.png');
        background-repeat: no-repeat, no-repeat;
        background-position: right 30px top 20px, left 30px bottom 20px;
        background-size: 120px, 120px;
    }

    th, td, select {
        padding: 8px;
        text-align: center;
        border: 2px solid #ccc;
    }

    th {
        background-color: #f8f8f8;
        font-weight: bold;
    }

    select {
        width: 100%;
        box-sizing: border-box;
    }

    h2 {
        color: #0d6efd;
        margin-bottom: 20px;
        text-align: center;
    }

    .bg-success {
        background-color: #198754 !important;
        color: white;
    }

    .bg-danger {
        background-color: #dc3545 !important;
        color: white;
    }

    .bg-warning {
        background-color: #ffc107 !important;
        color: black;
    }

    .btn-danger-small {
        padding: 2px 6px;
        font-size: 0.8rem;
        margin-top: 4px;
    }
</style>

<div class="background-logo"></div>

<div class="container-custom">
    <img src="https://i.imgur.com/K9Ugseg.gif" class="logo" />
    <h2>Calendario Assenze</h2>

    <table>
        <thead>
            <tr>
                <th>Giorno</th>
                <th>Data</th>
                <th>Reperibile</th>
                <th>Montuo</th>
                <th>Flavio</th>
                <th>Bosax</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var giorno in Model)
            {
                var giornoSet = giorno.Data.ToString("dddd", new CultureInfo("it-IT"));
                var repClass = giorno.Reperibile == "In attesa" ? "bg-warning"
                : giorno.Reperibile == "Nessuno" ? "bg-danger" : "bg-success";

                <tr>
                    <td>@giornoSet</td>
                    <td>@giorno.Data.ToString("dd/MM/yyyy")</td>

                    <td class="@repClass">
                        <select class="reperibile-select" data-id="@giorno.Id">
                            <option value="In attesa" selected="@(giorno.Reperibile == "In attesa" ? "selected" : null)">In attesa</option>
                            <option value="Montuo" selected="@(giorno.Reperibile == "Montuo" ? "selected" : null)">Montuo</option>
                            <option value="Flavio" selected="@(giorno.Reperibile == "Flavio" ? "selected" : null)">Flavio</option>
                            <option value="Bosax" selected="@(giorno.Reperibile == "Bosax" ? "selected" : null)">Bosax</option>
                            <option value="Nessuno" selected="@(giorno.Reperibile == "Nessuno" ? "selected" : null)">Nessuno</option>
                        </select>
                    </td>

                    @foreach (var membro in new[] { "Montuo", "Flavio", "Bosax" })
                    {
                        var assenza = membro switch
                        {
                            "Montuo" => giorno.Montuo,
                            "Flavio" => giorno.Flavio,
                            "Bosax" => giorno.Bosax,
                            _ => null
                        };

                        var bgClass = assenza == "assente" ? "bg-danger" : "bg-warning";

                        <td class="@bgClass">
                            <select class="assenza-select" data-id="@giorno.Id" data-nome="@membro">
                                <option value="" selected="@(string.IsNullOrWhiteSpace(assenza) ? "selected" : null)"></option>
                                <option value="assente" selected="@(assenza == "assente" ? "selected" : null)">assente</option>
                            </select>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        $(function () {
            $('.reperibile-select').on('change', function () {
                const sel = $(this);
                const id = sel.data('id');
                const val = sel.val();
                const td = sel.closest('td');

                $.post('/CalendarioAssenze/AggiornaReperibile', { id: id, reperibile: val })
                    .done(() => {
                        td.removeClass('bg-success bg-danger bg-warning');
                        if (val === 'Nessuno') td.addClass('bg-danger');
                        else if (val === 'In attesa') td.addClass('bg-warning');
                        else td.addClass('bg-success');
                    })
                    .fail(() => alert("Errore durante il salvataggio della reperibilità."));
            });

            $('.assenza-select').on('change', function () {
                const sel = $(this);
                const id = sel.data('id');
                const nome = sel.data('nome');
                const val = sel.val();
                const td = sel.closest('td');

                $.post('/CalendarioAssenze/AggiornaAssenza', { id: id, nome: nome, stato: val })
                    .done(() => {
                        td.removeClass('bg-success bg-danger bg-warning');
                        if (val === "assente") td.addClass('bg-danger');
                        else td.addClass('bg-warning');
                    })
                    .fail(() => alert("Errore durante il salvataggio dell'assenza."));
            });
        });
    </script>
}
