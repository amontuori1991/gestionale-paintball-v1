@model Full_Metal_Paintball_Carmagnola.Models.Promozione
@{
    Layout = null; // poster pulito per la stampa
    var qrSrc = $"data:image/png;base64,{ViewBag.QRBase64}";
    var url = (string)ViewBag.UrlAssoluto;

    // colori
    string ACCENT = ViewBag.Accent as string ?? "#7c3aed";
    string ACCENT_SOFT = ViewBag.AccentSoft as string ?? "#ede9fe";
    string ACCENT_DARK = ViewBag.AccentDark as string ?? "#4c1d95";
    string LOGO = ViewBag.LogoUrl as string ?? Url.Content("~/img/logo.gif");
}

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <title>Poster QR — @Model.Nome</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --accent: @ACCENT;
            --accent-soft: @ACCENT_SOFT;
            --accent-dark: @ACCENT_DARK;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            color: #0f172a;
            background: radial-gradient(1200px 800px at 20% -10%, rgba(124,58,237,.10), transparent 60%), radial-gradient(1000px 700px at 120% 10%, rgba(22,163,74,.10), transparent 55%), #f8fafc;
        }

        .no-print {
            display: flex;
            gap: .5rem;
            justify-content: center;
            padding: 12px;
            position: sticky;
            top: 0;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #fff;
            cursor: pointer;
            text-decoration: none;
            color: #111
        }

        .poster {
            max-width: 820px;
            margin: 22px auto;
            background: #ffffff;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 14px 40px rgba(15,23,42,.10);
            border: 1px solid #e5e7eb;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 22px 26px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #fff;
        }

            .header img {
                height: 68px;
                width: auto;
                border-radius: 8px;
                background: #fff;
                padding: 6px;
            }

            .header h1 {
                margin: 0;
                font-size: 30px;
                letter-spacing: .2px;
            }

        .body {
            padding: 26px;
            background: radial-gradient(800px 400px at 75% 0%, var(--accent-soft), transparent 60%), linear-gradient(#fff, #fff);
        }

        .grid {
            display: grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 24px;
            align-items: center;
        }

        @@media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .desc {
            color: #334155;
            line-height: 1.6;
            margin: 8px 0 14px;
            white-space: pre-line;
        }

        .meta {
            margin-top: 6px;
            font-size: 14px;
            color: #475569;
        }

        .cta {
            margin-top: 14px;
            font-weight: 700;
            font-size: 22px;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

            .cta .dot {
                width: 10px;
                height: 10px;
                background: var(--accent);
                border-radius: 50%;
                box-shadow: 0 0 0 6px var(--accent-soft);
            }

        .qrwrap {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px;
            border-radius: 18px;
            background: #ffffff;
            border: 1px dashed #d8dee9;
            box-shadow: 0 12px 30px rgba(2,6,23,.06);
        }
            /* Glow VERDE (no miscelazione viola) */
            .qrwrap::before {
                content: "";
                position: absolute;
                inset: -14px;
                background: radial-gradient(420px 280px at 35% 50%, rgba(16,185,129,.28), transparent 60%);
                filter: blur(18px);
                z-index: 0;
                border-radius: 24px;
                pointer-events: none;
            }

            .qrwrap img {
                position: relative;
                z-index: 1;
                width: 360px;
                height: 360px;
                image-rendering: crisp-edges;
            }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 26px;
            border-top: 1px dashed #e2e8f0;
            background: #f8fafc;
        }

        .url {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            background: #fff;
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            color: #0f172a;
        }

        /* ---------- STAMPA A4 LANDSCAPE + colori fedeli ---------- */
        @@media print {
            @@page {
                size: A4 landscape;
                margin: 0;
            }

            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }

            #poster {
                width: 297mm !important;
                min-height: 210mm !important;
                margin: 0 !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                break-inside: avoid;
                page-break-inside: avoid;
            }
            /* Glow più saturo in stampa per evitare viraggio al grigio */
            .qrwrap::before {
                background: radial-gradient(460px 300px at 35% 50%, rgba(16,185,129,.34), transparent 60%) !important;
                filter: blur(16px) !important;
            }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <button onclick="window.print()" class="btn">🖨️ Stampa</button>
        <button id="dlPng" class="btn">⬇️ Scarica PNG</button>
        <button id="dlPdf" type="button" class="btn">📄 Scarica PDF A4</button>
        <a href="@Url.Action("Archivio", "Promozioni")" class="btn">⬅️ Archivio</a>
    </div>

    <div id="poster" class="poster">
        <div class="header">
            <img src="@LOGO" alt="Logo">
            <div>
                <h1>@Model.Nome</h1>
            </div>
        </div>

        <div class="body">
            <div class="grid">
                <div class="left">
                    @if (!string.IsNullOrWhiteSpace(Model.Descrizione))
                    {
                        <p class="desc">@Model.Descrizione</p>
                    }
                    <div class="cta"><span class="dot"></span>Scansiona il QR per richiedere il tuo codice!</div>
                    <p class="meta">
                        Alias: <strong>@Model.Alias</strong><br />
                        Valida fino al <strong>@Model.DataScadenza.ToString("dd/MM/yyyy")</strong>
                    </p>
                </div>
                @if (!string.IsNullOrWhiteSpace(Model.CosaDaDiritto))
                {
                    <div class="mt-2 p-3" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:12px;">
                        <div class="small" style="color:#475569;">Il buono dà diritto a:</div>
                        <div class="fw-semibold" style="color:#0f172a;">@Model.CosaDaDiritto</div>
                    </div>
                }

                <div class="qrwrap">
                    <img src="@qrSrc" alt="QR @Model.Alias" />
                </div>
            </div>
        </div>

        <div class="footer">
            <div>Mostra il codice in cassa al momento dell’arrivo.</div>
            <div class="url">@url</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // PNG ad alta risoluzione
        document.getElementById('dlPng').addEventListener('click', async function () {
          const el = document.getElementById('poster');
          const canvas = await html2canvas(el, {
            scale: 3,
            useCORS: true,
            backgroundColor: '#ffffff'
          });
          const a = document.createElement('a');
          a.download = '@($"poster-{Model.Alias}.png")';
          a.href = canvas.toDataURL('image/png');
          a.click();
        });

        // PDF A4 LANDSCAPE
        document.getElementById('dlPdf').addEventListener('click', async function () {
          const el = document.getElementById('poster');
          if (!el) { alert('Poster non trovato'); return; }

          const canvas = await html2canvas(el, {
            scale: 3,
            useCORS: true,
            backgroundColor: '#ffffff'
          });

          const JsPDFCtor = window.jspdf && window.jspdf.jsPDF;
          if (!JsPDFCtor) { alert('jsPDF non caricato.'); return; }

          const imgData = canvas.toDataURL('image/png');
          const pdf = new JsPDFCtor({ orientation: 'landscape', unit: 'mm', format: 'a4' });

          const pageW = pdf.internal.pageSize.getWidth();   // ~297
          const pageH = pdf.internal.pageSize.getHeight();  // ~210

          const imgW = pageW;                                // riempi larghezza
          const imgH = canvas.height * imgW / canvas.width; // mantieni proporzioni
          const y = Math.max(0, (pageH - imgH) / 2);        // centra verticalmente

          pdf.addImage(imgData, 'PNG', 0, y, imgW, imgH, undefined, 'FAST');

          try {
            pdf.save('@($"poster-{Model.Alias}.pdf")');
          } catch {
            const blob = pdf.output('blob');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '@($"poster-{Model.Alias}.pdf")';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
          }
        });
    </script>
</body>
</html>
