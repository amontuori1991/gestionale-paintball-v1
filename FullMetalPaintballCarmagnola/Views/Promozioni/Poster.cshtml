@model Full_Metal_Paintball_Carmagnola.Models.Promozione
@{
    Layout = null; // poster pulito per la stampa/preview
    var qrSrc = $"data:image/png;base64,{ViewBag.QRBase64}";
    var url = (string)ViewBag.UrlAssoluto;

    // colori
    string ACCENT = ViewBag.Accent as string ?? "#16a34a";      // verde
    string ACCENT_SOFT = ViewBag.AccentSoft as string ?? "#e6f7ed";
    string ACCENT_DARK = ViewBag.AccentDark as string ?? "#0f7a34";
    string LOGO = ViewBag.LogoUrl as string ?? Url.Content("~/img/logo.gif");
}

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <title>Poster Promo — @Model.Nome</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --accent: @ACCENT;
            --accent-soft: @ACCENT_SOFT;
            --accent-dark: @ACCENT_DARK;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f8fafc;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Barra comandi (solo preview) */
        .controls.no-print {
            display: flex;
            gap: .5rem;
            justify-content: center;
            padding: 12px;
            position: sticky;
            top: 0;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            z-index: 5;
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #fff;
            cursor: pointer;
            text-decoration: none;
            color: #111;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }

        /* Cornice a proporzione A4: la preview si adatta allo schermo senza tagli */
        .a4-frame {
            width: min(96vw, 1400px);
            aspect-ratio: 297 / 210; /* A4 landscape */
            margin: 12px auto 24px;
            display: grid;
            place-items: center;
            overflow: visible;
            padding: 8px;
            box-sizing: border-box;
        }

        /* Base poster: dimensioni logiche fisse; viene scalata dentro la frame */
        .a4-base {
            width: 1860px; /* canvas logico (proporzione A4) */
            height: 1316px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 14px 40px rgba(15,23,42,.10);
            transform-origin: top left; /* scala da angolo in JS */

            display: flex; /* struttura a piena altezza */
            flex-direction: column;
        }

        /* HEADER centrato sulla fascia */
        .header {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 24px 30px;
            min-height: 120px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #fff;
        }

        .header-inner {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header img {
            height: 92px;
            width: auto;
            border-radius: 10px;
            background: #fff;
            padding: 8px;
        }

        .header h1 {
            margin: 0;
            font-size: 64px; /* grande per distanza */
            letter-spacing: .2px;
            font-weight: 800;
            line-height: 1;
        }

        /* BODY riempie lo spazio tra header e footer */
        .body {
            flex: 1 1 auto;
            padding: 26px 28px 22px;
            background: radial-gradient(900px 420px at 80% 10%, var(--accent-soft), transparent 60%), linear-gradient(#fff,#fff);
            box-sizing: border-box;
            display: grid;
        }

        /* GRIGLIA: sinistra molto più larga per testi enormi */
        .grid {
            display: grid;
            grid-template-columns: 1.35fr .65fr; /* sinistra dominante */
            gap: 26px;
            align-items: stretch;
            height: 100%;
        }
        @@media (max-width: 900px) {
            .grid

        {
            grid-template-columns: 1fr;
            height: auto;
        }

        }

        /* COLONNA SINISTRA: tipografia “da poster” */
        .left {
            display: flex;
            flex-direction: column;
            gap: 24px;
            /* famiglia “black/bold” con fallback comuni */
            font-family: "Segoe UI", "Segoe UI Black", "Arial Black", Impact, Arial, Helvetica, sans-serif;
            letter-spacing: .2px;
        }
        /* Descrizione (lead) – molto visibile */
        .lead {
            color: #0f172a;
            font-size: 36px; /* ↑ */
            line-height: 1.28;
            font-weight: 700;
            margin: 0;
        }
        /* CTA – stampatello enorme */
        .cta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 48px; /* ↑ parecchio */
            font-weight: 900;
            color: #0f172a;
            margin: 0;
            text-transform: uppercase; /* STAMPATELLO */
        }

            .cta .dot {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: var(--accent);
                box-shadow: 0 0 0 10px var(--accent-soft);
            }
        /* Metadati – blocchi separati, grandi e leggibili */
        .meta {
            display: grid;
            gap: 6px;
            margin: 0;
        }

            .meta .line {
                font-size: 28px; /* ↑ */
                color: #0f172a;
            }

            .meta .label {
                text-transform: uppercase;
                font-weight: 800;
                letter-spacing: .5px;
                opacity: .9;
            }

            .meta .value {
                font-weight: 800;
            }
        /* Beneficio – card corposa */
        .right-card {
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px 16px;
            color: #0f172a;
            font-size: 28px; /* ↑ */
            line-height: 1.45;
        }

            .right-card .small {
                color: #475569;
                font-size: 20px;
                margin-bottom: 6px;
                text-transform: uppercase;
                letter-spacing: .5px;
            }

        /* COLONNA DESTRA: QR pieno */
        .qrwrap {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 18px;
            background: #fff;
            border: 1px dashed #d8dee9;
            box-shadow: 0 12px 30px rgba(2,6,23,.06);
            position: relative;
        }

            .qrwrap::before {
                content: "";
                position: absolute;
                inset: -18px;
                background: radial-gradient(520px 340px at 35% 50%, rgba(16,185,129,.30), transparent 60%);
                filter: blur(18px);
                border-radius: 24px;
                pointer-events: none;
            }

            .qrwrap img {
                max-height: 100%;
                max-width: 100%;
                width: auto;
                height: auto;
                image-rendering: crisp-edges;
            }

        /* FOOTER compatto */
        .footer {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 22px;
            border-top: 1px dashed #e2e8f0;
            background: #f8fafc;
            gap: 16px;
        }

        .footnote {
            font-size: 22px;
            color: #0f172a;
        }

        .url {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            background: #fff;
            color: #0f172a;
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 26px;
            margin-left: auto;
        }

        /* Stampa */
        @@media print {
            .no-print {
                display: none !important;
            }

            @@page {
                size: A4 landscape;
                margin: 10mm;
            }

            html, body {
                background: #fff !important;
            }
        }

        /* MOBILE */
        @@media (max-width: 900px) {
            .header h1

        {
            font-size: 42px;
        }

        .lead {
            font-size: 22px;
        }

        .cta {
            font-size: 28px;
        }

        .meta .line {
            font-size: 18px;
        }

        .right-card {
            font-size: 20px;
        }

        .url {
            font-size: 18px;
        }

        .qrwrap img {
            width: 340px;
            height: 340px;
            max-width: 100%;
        }

        }
    </style>
</head>
<body>

    <div class="controls no-print">
        <a href="@Url.Action("Archivio", "Promozioni")" class="btn">⬅️ Archivio</a>
        <button id="printBtn" class="btn">🖨️ Stampa</button>
        <button id="dlPng" class="btn">⬇️ Scarica PNG</button>
        <button id="dlPdf" class="btn">📄 Scarica PDF A4</button>
    </div>

    <!-- FRAME A4 -->
    <div id="a4Frame" class="a4-frame">
        <div id="a4Base" class="a4-base">
            <!-- Header -->
            <div class="header">
                <div class="header-inner">
                    <img src="@LOGO" alt="Logo" />
                    <h1>@Model.Nome</h1>
                </div>
            </div>

            <!-- Corpo -->
            <div class="body">
                <div class="grid">
                    <div class="left">
                        @if (!string.IsNullOrWhiteSpace(Model.Descrizione))
                        {
                            <p class="lead">@Model.Descrizione</p>
                        }

                        <p class="cta"><span class="dot"></span>Scansiona il QR per richiedere il tuo codice!</p>

                        <div class="meta">
                            <div class="line"><span class="label">Alias:</span> <span class="value">@Model.Alias</span></div>
                            <div class="line"><span class="label">Valida fino al</span> <span class="value">@Model.DataScadenza.ToString("dd/MM/yyyy")</span></div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Model.CosaDaDiritto))
                        {
                            <div class="right-card">
                                <div class="small">Il buono dà diritto a:</div>
                                <div class="fw-semibold">@Model.CosaDaDiritto</div>
                            </div>
                        }
                    </div>

                    <div class="qrwrap">
                        <img src="@qrSrc" alt="QR @Model.Alias" />
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <div class="footnote">Mostra il codice in cassa al momento dell’arrivo.</div>
                <div class="url">@url</div>
            </div>
        </div>
    </div>

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        (function(){
          const BASE_W = 1860, BASE_H = 1316;   // base poster (px) proporzione A4
          const DL_W   = 2480, DL_H   = 1754;   // render per download/stampa (A4 ~300dpi "light")

          // Fit: scala la base dentro la cornice A4 senza tagli
          const frame = document.getElementById('a4Frame');
          const base  = document.getElementById('a4Base');
          function fit(){
            const s = Math.min(frame.clientWidth / BASE_W, frame.clientHeight / BASE_H);
            base.style.transform = 'scale(' + s + ')';
          }
          window.addEventListener('resize', fit, { passive:true });
          requestAnimationFrame(fit);

          // Render completo off-screen per PNG/PDF/Print
          async function renderPosterDataURL() {
            const clone = base.cloneNode(true);
            clone.style.transform = 'none';
            clone.style.width = DL_W + 'px';
            clone.style.height = DL_H + 'px';
            clone.style.position = 'fixed';
            clone.style.left = '-100000px';
            clone.style.top = '0';
            document.body.appendChild(clone);

            const canvas = await html2canvas(clone, { scale: 1, useCORS: true, backgroundColor: '#ffffff' });
            clone.remove();
            return canvas.toDataURL('image/png');
          }

          // Stampa
          document.getElementById('printBtn').addEventListener('click', async function(){
            const dataUrl = await renderPosterDataURL();
            const w = window.open('', '_blank');
            if(!w) return;
            const style = w.document.createElement('style');
            style.textContent = '@@page { size: A4 landscape; margin: 10mm; } html,body{margin:0;background:#fff;} img{width:100%;height:auto;display:block;}';
            w.document.head.appendChild(style);
            const img = w.document.createElement('img');
            img.src = dataUrl;
            w.document.body.appendChild(img);
            w.onload = () => w.print();
          });

          // Download PNG
          document.getElementById('dlPng').addEventListener('click', async function(){
            const dataUrl = await renderPosterDataURL();
            const a = document.createElement('a');
            a.download = 'poster-@@Model.Alias.png';
            a.href = dataUrl;
            a.click();
          });

          // Download PDF A4
          document.getElementById('dlPdf').addEventListener('click', async function(){
            const dataUrl = await renderPosterDataURL();
            const JsPDFCtor = window.jspdf && window.jspdf.jsPDF;
            if (!JsPDFCtor) return alert('jsPDF non caricato');
            const pdf = new JsPDFCtor({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageW = pdf.internal.pageSize.getWidth();   // ~297
            const pageH = pdf.internal.pageSize.getHeight();  // ~210
            const imgW = pageW;
            const imgH = imgW * (DL_H / DL_W);
            const y = Math.max(0, (pageH - imgH) / 2);
            pdf.addImage(dataUrl, 'PNG', 0, y, imgW, imgH, undefined, 'FAST');
            pdf.save('poster-@@Model.Alias.pdf');
          });
        })();
    </script>
</body>
</html>
